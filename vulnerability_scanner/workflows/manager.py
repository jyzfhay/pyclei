from protocols.http import HttpScanner
from protocols.dns import DnsScanner
from protocols.tcp import TcpScanner
from protocols.udp import UdpScanner
from protocols.ftp import FtpScanner
from protocols.smtp import SmtpScanner
from utils.matcher import match_http_response, match_dns_response, match_tcp_response, match_udp_response

class WorkflowManager:
    def __init__(self, templates):
        self.templates = templates

    def execute(self):
        results = []
        for template in self.templates:
            protocol = template['protocol']
            if protocol == 'http':
                scanner = HttpScanner(template)
                response = scanner.scan()
                if match_http_response(template, response):
                    results.append(f"Vulnerability found for {template['url']}")
            elif protocol == 'dns':
                scanner = DnsScanner(template)
                response = scanner.scan()
                if match_dns_response(template, response):
                    results.append(f"Vulnerability found for {template['domain']}")
            elif protocol == 'tcp':
                scanner = TcpScanner(template)
                response = scanner.scan()
                if match_tcp_response(template, response):
                    results.append(f"Vulnerability found for {template['host']}:{template['port']}")
            elif protocol == 'udp':
                scanner = UdpScanner(template)
                response = scanner.scan()
                if match_udp_response(template, response):
                    results.append(f"Vulnerability found for {template['host']}:{template['port']}")
            elif protocol == 'ftp':
                scanner = FtpScanner(template)
                response = scanner.scan()
                if template['match']['expected_response'] in response:
                    results.append(f"Vulnerability found for {template['host']}:{template['port']}")
            elif protocol == 'smtp':
                scanner = SmtpScanner(template)
                response = scanner.scan()
                if template['match']['expected_response'] in response:
                    results.append(f"Vulnerability found for {template['host']}:{template['port']}")
        return results
